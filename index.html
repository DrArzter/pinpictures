<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <title>PinPictures</title>
</head>

<body class="bg-gradient-to-br from-zinc-950 to-zinc-900 min-h-screen">
  <div id="notification-container"
    class="fixed top-0 right-0 mt-20 mr-4 text-white p-4 rounded-2xl shadow-2xl hidden z-50" wfd-invisible="false">
  </div>

  <header class="flex flex-row justify-between bg-zinc-800 py-4 px-4 sm:px-8 text-slate-200 rounded-b-2xl">
    <div class="flex flex-row items-center">
      <p class="cursor-pointer sm:text-xl lg:text-2xl text-slate-200" onclick="window.location.href = '/'">
        PinPictures
      </p>
    </div>
    <div class="flex flex-row justify-between rounded-2xl bg-slate-200 p-2 w-1/2">
      <svg class="w-6 cursor-pointer" onclick="createPostForm()" viewBox="0 0 24 24" fill="none"
        xmlns="http://www.w3.org/2000/svg">
        <path d="M4 12H20M12 4V20" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
      </svg>
      <input class="focus:outline-none bg-slate-200 text-zinc-800 w-full p-2" type="text" placeholder="Search"  id="searchBar"/>
      <button>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none">
          <path
            d="M14.9536 14.9458L21 21M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z"
            stroke="#000000" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
      </button>
    </div>
    <div id="loginButtonDiv" class="self-center">
      <button onclick="window.location.href = '/auth/'"
        class="hidden sm:text-lg lg:text-xl px-4 py-1 rounded-2xl bg-slate-200 text-zinc-950 hover:bg-zinc-700 hover:text-slate-200 transition duration-500"
        id="loginButton">
        Login
      </button>
    </div>
  </header>

  <main class="mt-4 py-4 px-4 md:px-32">
    <div id="Posts" class="flex flex-col gap-2 mt-4 grid-rows-auto"></div>
    <div id="createPostForm"
      class="w-auto mx-auto bg-zinc-800/50 text-black p-6 rounded-2xl shadow-2xl hidden z-50 fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 p-10">
      <div class="flex flex-col gap-2 items-center">
        <div class="grid grid-cols-3 gap-32 items-center">
          <div class="col-span-1"></div>
          <div class="col-span-1 text-center">
            <p class="text-slate-200">Create post</p>
          </div>
          <div class="col-span-1 flex justify-end">
            <svg width="32" id="cancelCreatePostButton" class="cursor-pointer fill-red-600" viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd" clip-rule="evenodd"
                d="M16.9498 8.46447C17.3404 8.07394 17.3404 7.44078 16.9498 7.05025C16.5593 6.65973 15.9261 6.65973 15.5356 7.05025L12.0001 10.5858L8.46455 7.05025C8.07402 6.65973 7.44086 6.65973 7.05033 7.05025C6.65981 7.44078 6.65981 8.07394 7.05033 8.46447L10.5859 12L7.05033 15.5355C6.65981 15.9261 6.65981 16.5592 7.05033 16.9497C7.44086 17.3403 8.07402 17.3403 8.46455 16.9497L12.0001 13.4142L15.5356 16.9497C15.9261 17.3403 16.5593 17.3403 16.9498 16.9497C17.3404 16.5592 17.3404 15.9261 16.9498 15.5355L13.4143 12L16.9498 8.46447Z" />
            </svg>
          </div>
        </div>
        <div class="flex flex-row gap-2 mt-4">
          <input type="file" id="postImage" class="rounded-2xl text-slate-200/0 hidden" />
          <label for="postImage" id="postImageLabel"
            class="w-72 h-72 bg-gray-200 flex items-center justify-center rounded-2xl cursor-pointer">
            <svg fill="#000000" class="w-12 h-12" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg">
              <title>plus-file</title>
              <path
                d="M4 30.016q0 0.832 0.576 1.408t1.44 0.576h16.992q1.824 0 3.488-0.704t2.88-1.92 1.92-2.88 0.704-3.488q0-2.272-1.088-4.224t-2.912-3.232v-7.552l-8-8h-13.984q-0.832 0-1.44 0.608t-0.576 1.408v28zM8 28v-24h10.016v6.016h5.984v4.096q-0.576-0.128-0.992-0.128-1.824 0-3.488 0.736t-2.88 1.92-1.92 2.848-0.704 3.52q0 2.72 1.504 4.992h-7.52zM18.016 23.008q0-2.080 1.44-3.52t3.552-1.472 3.52 1.472 1.472 3.52-1.472 3.552-3.52 1.44-3.552-1.44-1.44-3.552zM20 24h2.016v2.016h1.984v-2.016h2.016v-1.984h-2.016v-2.016h-1.984v2.016h-2.016v1.984z" />
              <script xmlns id="bw-fido2-page-script" />
            </svg>
          </label>
          <div class="flex flex-col">
            <p class="text-slate-200 mx-2">Title</p>
            <textarea placeholder="Add a title"
              class="focus:outline-none resize-none w-full bg-slate-200 text-zinc-800 rounded-2xl p-2" id="postTitle">
              </textarea>
            <p class="text-slate-200 mx-2">Description</p>
            <textarea placeholder="Add a description"
              class="focus:outline-none resize-none w-full bg-slate-200 text-zinc-800 rounded-2xl p-2"
              id="postDescription">
              </textarea>
          </div>
        </div>
        <div class="flex gap-2">
          <button id="submitCreatePostButton"
            class="bg-green-600/50 text-slate-200 backdrop-blur-xl shadow-md w-11/12 hover:bg-green-400/90 transition duration-700 py-2 px-4 m-1 rounded-2xl hover:text-slate-900">
            Upload
          </button>
        </div>
      </div>
    </div>
  </main>

  <script>
    posts = [];
    function getPosts(page) {
      newPosts = [];
      $.ajax({
        type: "GET",
        url: "api/posts/posts.php?page=" + page,
        success: function (data) {
          newPosts = JSON.parse(data);
          for (let i = 0; i < newPosts.length; i++) {
            posts.push(newPosts[i]);
          }
          showPosts(newPosts);
        },
      });
    }

    function getComments(postID) {
      comments = [];
      comments = JSON.parse(posts[getIndex(postID)].comments);
      return comments;
    }

    function showNotification(message, type) {
      const notificationContainer = document.getElementById(
        "notification-container"
      );
      notificationContainer.textContent = message;

      notificationContainer.classList.remove("bg-green-500", "bg-red-500");

      if (type === "success") {
        notificationContainer.classList.add("bg-green-500");
      } else if (type === "error") {
        notificationContainer.classList.add("bg-red-500");
      }

      notificationContainer.style.display = "block";

      setTimeout(() => {
        notificationContainer.style.display = "none";
      }, 5000);
    }

    function addComment(postID, content) {
      postID = parseInt(postID);
      $.ajax({
          type: "POST",
          url: "api/posts/posts.php",
          contentType: "application/json",
          data: JSON.stringify({
              type: "createComment",
              postID: postID,
              content: content,
          }),
          success: function (data) {
            data = JSON.parse(data);
            let commentsHTML = "";
            console.log(data);
            console.log(data.comments);
            for (let i = 0; i < (data.comments).length; i++) {
              commentsHTML += `<div><div>${data.comments[i].user_name}</div><div>${data.comments[i].content}</div></div>`;
            }
            $("[postid=" + postID + "]").find("#Comments").html(commentsHTML);
        },
        error: function (xhr, status, error) {
            var responseData = JSON.parse(xhr.responseText);
            showNotification(responseData.message, responseData.status);
        }
      });
    }

    function createPostForm() {
      document.getElementById("postDescription").value = "";
      document.getElementById("postTitle").value = "";
      document.getElementById("createPostForm").classList.toggle("hidden");
      document.getElementById("cancelCreatePostButton").onclick = () => {
        document.getElementById("createPostForm").classList.toggle("hidden");
      };
      document.getElementById("submitCreatePostButton").onclick = () => {
        var formData = new FormData();
        formData.append("type", "createPost");
        formData.append("title", document.getElementById("postTitle").value);
        formData.append(
          "description",
          document.getElementById("postDescription").value
        );
        formData.append(
          "image",
          document.getElementById("postImage").files[0]
        );
        $.ajax({
          type: "POST",
          url: "api/posts/posts.php",
          data: formData,
          processData: false,
          contentType: false,
          success: function (data) {
            data = JSON.parse(data);
            document
              .getElementById("createPostForm")
              .classList.toggle("hidden");
            getPosts(1);
          },
          error: function (xhr, status, error) {
            data = JSON.parse(xhr.responseText);
            showNotification(data.message, data.status);
          },
        });
      };
    }

    function showPosts(postsData) {
      let postsContainer = document.getElementById("Posts");
      postsContainer.innerHTML = "";

      postsData.forEach(function (post, index) {
        let postDiv = document.createElement("div");
        postDiv.classList.add('flex', 'flex-row', 'justify-between', 'gap-4', 'rounded-2xl', 'p-2', 'bg-slate-200/10', 'w-full', 'h-full', 'sm:mx-auto', 'backdrop-blur-xl', 'shadow-inner', 'shadow-slate-200/50');
        postDiv.setAttribute("id", post.id);

        let imgDiv = document.createElement("div");
        imgDiv.classList.add('w-1/2');
        postDiv.appendChild(imgDiv);

        let image = document.createElement("img");
        image.classList.add('w-full', 'rounded-2xl');
        image.setAttribute("src", "/storage/imgs/" + post.picPath);
        imgDiv.appendChild(image);

        let textDiv = document.createElement("div");
        textDiv.classList.add('w-1/2');
        postDiv.appendChild(textDiv);

        let profileDiv = document.createElement("div");
        profileDiv.classList.add('flex', 'flex-row', 'gap-2', 'w-full');
        textDiv.appendChild(profileDiv);

        let profilePic = document.createElement("img");
        profilePic.classList.add('w-8', 'h-8', 'sm:w-12', 'sm:h-12', 'rounded-full');
        profilePic.setAttribute("src", "/storage/avatars/" + post.avatarPath + "?v=" + Date.now());
        profileDiv.appendChild(profilePic);

        let profileName = document.createElement("p");
        profileName.classList.add('flex', 'flex-row', 'items-center', 'text-slate-200', 'font-bold', 'self-center', 'text-sm', 'md:text-md');
        profileName.setAttribute("userID", post.authorID);
        profileName.innerHTML = post.nickname;
        profileDiv.appendChild(profileName);

        let title = document.createElement("p");
        title.classList.add('text-slate-200', 'font-bold', 'self-center', 'text-sm', "mt-2", 'md:text-md');
        title.innerHTML = post.title;
        textDiv.appendChild(title);

        let likes = document.createElement("div");
        likes.classList.add('flex', 'flex-row', "mt-2", 'items-center');
        likes.setAttribute("id", "Likes");
        textDiv.appendChild(likes);

        let likeButton = document.createElement("button");
        likeButton.classList.add('flex', 'flex-row', 'items-center', 'bg-white', 'hover:bg-red-200', 'rounded-2xl', 'border-2', 'p-1');
        likeButton.setAttribute("postID", post.id);
        likeButton.setAttribute("onclick", "likePost(this.getAttribute('postID'))");
        likes.appendChild(likeButton);

        let likeSVG = document.createElement("svg");
        likeSVG.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" class="h-8 w-8 icon" version="1.1"><path d="M933.387 517.868C950.274 477.276 960 431.509 960 382.887c0-165.301-109.993-299.305-245.677-299.305-83.964 0-158.011 51.39-202.323 129.684-44.31-78.295-118.357-129.685-202.321-129.685C173.994 83.581 64 217.586 64 382.887c0 57.701 13.632 111.398 36.851 157.102 56.694 135.957 196.112 269.389 414.1 400.428 149.872-95.245 273.613-208.473 368.923-341.271 14.435-16.802 49.513-81.278 49.513-81.278z" fill="#FF3B30"/><path d="M484 254.385c8.327-14.713 17.706-28.474 28-41.12-57.022-96.69-134.136-129.682-202.321-129.682-9.409 0-18.659 0.786-27.794 2.039C354.075 95.7 444.727 184.995 484 254.385zM714.323 83.583c-9.547 0-18.946 0.75-28.206 2.039C808.697 102.462 904 229.049 904 382.888c0 48.623-9.724 94.386-26.613 134.982 0 0-35.08 64.473-49.515 81.277-89.475 124.668-204.315 231.88-342.002 323.366 9.592 5.971 19.163 11.942 29.079 17.905 149.872-95.244 273.613-208.474 368.923-341.271 14.434-16.805 49.514-81.277 49.514-81.277C950.276 477.274 960 431.511 960 382.888c0-165.302-109.993-299.305-245.677-299.305z" fill=""/></svg>';

        let likeCount = document.createElement("p");
        likeCount.setAttribute("id", "likeCount");
        likeCount.innerHTML = post.likes_count;

        likeButton.appendChild(likeSVG);
        likeButton.appendChild(likeCount);

        let commentsDiv = document.createElement("div");
        commentsDiv.classList.add("bg-slate-200", "p-2", "rounded-2xl", "w-full", "text-zinc-800", "mt-8");
        commentsDiv.setAttribute("id", "Comments");

        let addCommentDiv = document.createElement("div");
        addCommentDiv.classList.add("flex", "flex-row", "gap-2", "w-2/5", "bg-zinc-800", "p-2", "rounded-2xl", "mt-4");
        addCommentDiv.setAttribute("postID", post.id);

        let commentInput = document.createElement("input");
        commentInput.setAttribute("type", "text");
        commentInput.setAttribute("id", "commentInput");
        commentInput.setAttribute("class", "rounded-2xl px-2");
        commentInput.setAttribute("placeholder", "Add a comment");
        
        commentInputButton = document.createElement("button");
        commentInputButton.setAttribute("id", "commentInputButton");
        commentInputButton.setAttribute("Class", "text-slate-200");
        commentInputButton.setAttribute("onclick", "addComment(this.parentElement.getAttribute('postID'), this.previousElementSibling.value)");
        commentInputButton.innerHTML = "-->";

        addCommentDiv.appendChild(commentInput);
        addCommentDiv.appendChild(commentInputButton);

        if (getComments(post.id) != null) {
          comments.forEach((comment) => {
            let commentDiv = document.createElement("div");
            

            let authorDiv = document.createElement("div");
            let authorName = document.createElement("p");
            let commentText = document.createElement("p");

            commentDiv.classList.add("flex", "flex-row", "gap-2", "w-full");

            authorName.innerHTML = comment.user_name;
            commentText.innerHTML = comment.content;

            authorDiv.appendChild(authorName);
            commentDiv.appendChild(authorDiv);
            commentDiv.appendChild(commentText);
            commentsDiv.appendChild(commentDiv);
            commentsDiv.appendChild(addCommentDiv);
            
          })
        } else {
          commentsDiv.innerHTML = "No comments yet. Be the first to comment!";
          commentsDiv.appendChild(addCommentDiv);
        }
        commentsDiv.setAttribute("id", "Comments");
        textDiv.appendChild(commentsDiv);

        postsContainer.appendChild(postDiv);
      });
    }

    function likePost(postID) {
      postID = parseInt(postID);
      $.ajax({
        type: "PATCH",
        url: "api/posts/posts.php",
        contentType: "application/json",
        data: JSON.stringify({
          type: "likePost",
          postID: postID,
        }),
        success: function (data) {
          data = JSON.parse(data);
          posts[getIndex(postID)].likes_count = data.likes;
          $("[postid=" + postID + "]").find("#likeCount").html(posts[getIndex(postID)].likes_count);
        },
        error: function (xhr, status, error) {
          data = JSON.parse(xhr.responseText);
          showNotification(data.message, data.status);
        },
      });
    }

    function getIndex(postID) {
      let index = posts.some((el, i) => {
        if (el.id === postID) {
          return true;
        }
      })
        ? posts.findIndex((el) => el.id === postID)
        : -1;
      return index;
    }

    function getUserData() {
      $.ajax({
        url: "/api/user/auth.php",
        type: "GET",
        success: function (data) {
          data = JSON.parse(data);
          if (data.status == "success") {
            buttonDiv = document.getElementById("loginButtonDiv");
            buttonDiv.innerHTML =
              '<p onclick="window.location.href = \'/profile/\'" class="cursor-pointer sm:text-lg lg:text-xl px-4 py-1 rounded-2xl bg-gray-200 text-black hover:bg-gray-800 hover:text-white transition duration-500">' +
              data.data.nickname +
              "</p>";
          } else {
            buttonDiv = document.getElementById("loginButton");
            buttonDiv.classList.toggle("hidden");
          }
        },
      });
    }

    document.addEventListener("DOMContentLoaded", function () {
      document.getElementById("searchBar").value = "";
      getUserData();
      getPosts(1);
    });
  </script>
</body>

</html>